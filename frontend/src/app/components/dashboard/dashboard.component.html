<nav class="navbar">
  <div class="navbar-content">
    <div class="navbar-left">
      <span class="navbar-title">Spotscout</span>
    </div>
    <div class="navbar-right">
      <button
        (click)="toggleSidebar()"
        class="bg-blue-500 text-white px-4 py-2 rounded-md"
      >
        Select
      </button>
      <button
        (click)="saveMap()"
        class="bg-green-500 text-white px-4 py-2 rounded-md"
      >
        Save
      </button>
      <button
        (click)="viewHistory()"
        class="bg-yellow-500 text-white px-4 py-2 rounded-md"
      >
        History
      </button>
      <button
        (click)="logout()"
        class="bg-red-500 text-white px-4 py-2 rounded-md"
      >
        Logout
      </button>
    </div>
  </div>
</nav>

<div id="map"></div>

<div class="sidebar" [ngClass]="{ open: isSidebarOpen }">
  <div class="sidebar-content">
    <button (click)="toggleSidebar()" class="close-button">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="2"
        stroke="currentColor"
        class="w-6 h-6"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>
    <input type="text" placeholder=" Latitude" #latInput />
    <input type="text" placeholder=" Longitude" #lonInput />
    <div class="checkbox-container flex items-center space-x-2 mt-1">
      <label class="relative inline-flex items-center cursor-pointer">
        <input class="sr-only peer" type="checkbox" [(ngModel)]="isMarkerLocked">
        <div class="group peer ring-0 bg-gradient-to-r from-emerald-400 to-emerald-900 rounded-full outline-none duration-700 after:duration-300 w-12 h-6 shadow-md peer-checked:bg-gradient-to-r peer-checked:from-rose-500 peer-checked:to-red-900 peer-focus:outline-none after:content-[''] after:rounded-full after:absolute after:bg-gray-50 after:outline-none after:h-5 after:w-5 after:top-0.5 after:left-0.5 peer-checked:after:translate-x-6 peer-hover:after:scale-95">
          <svg class="group-hover:scale-75 duration-300 absolute top-0.5 left-6 stroke-gray-900 w-5 h-5" height="50" preserveAspectRatio="xMidYMid meet" viewBox="0 0 100 100" width="50" x="0" xmlns="http://www.w3.org/2000/svg" y="0">
            <path class="svg-fill-primary" d="M50,18A19.9,19.9,0,0,0,30,38v8a8,8,0,0,0-8,8V74a8,8,0,0,0,8,8H70a8,8,0,0,0,8-8V54a8,8,0,0,0-8-8H38V38a12,12,0,0,1,23.6-3,4,4,0,1,0,7.8-2A20.1,20.1,0,0,0,50,18Z"></path>
          </svg>
          <svg class="group-hover:scale-75 duration-300 absolute top-0.5 left-0.5 stroke-gray-900 w-5 h-5" height="50" preserveAspectRatio="xMidYMid meet" viewBox="0 0 100 100" width="50" x="0" xmlns="http://www.w3.org/2000/svg" y="0">
            <path d="M30,46V38a20,20,0,0,1,40,0v8a8,8,0,0,1,8,8V74a8,8,0,0,1-8,8H30a8,8,0,0,1-8-8V54A8,8,0,0,1,30,46Zm32-8v8H38V38a12,12,0,0,1,24,0Z" fill-rule="evenodd"></path>
          </svg>
        </div>
      </label>
      <span class="text-white">Lock Location</span>
    </div>
    <label for="function">Select Function:</label>
    <select id="function" [(ngModel)]="selectedFunction">
      <option value="nearest">Nearest Place</option>
      <option value="count">Count Amenities</option>
      <option value="population">Population</option>
      <option value="predict">Predict Location</option>
    </select>

    <!-- Conditionally display the amenity selection based on the selected function -->
    <div *ngIf="selectedFunction === 'nearest' || selectedFunction === 'count'">
      <label for="amenity">Select Amenity:</label>
      <select id="amenity" [(ngModel)]="selectedAmenity">
        <option *ngFor="let option of filteredOptions | async" [value]="option">
          {{ option }}
        </option>
      </select>
    </div>
    <!-- <div *ngIf="selectedFunction === 'nearest' || selectedFunction === 'count'">
      <label for="amenity">Select Amenity:</label>
      <mat-form-field appearance="fill" class="custom-select">
        <mat-label>Select Amenity</mat-label>
        <input type="text" matInput [formControl]="searchControl" [matAutocomplete]="auto">
        <mat-autocomplete #auto="matAutocomplete">
          <mat-option *ngFor="let option of filteredOptions | async" [value]="option">
            {{ option }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </div> -->

    <!-- Add distance input for Count and Population -->
    <div
      *ngIf="selectedFunction === 'count' || selectedFunction === 'population'"
    >
      <label for="distance">Distance:</label>
      <input
        type="number"
        id="distance"
        [(ngModel)]="distance"
        min="100"
        step="100"
        (change)="validateDistance()"
      />
    </div>

    <button (click)="confirmSelection()" class="confirm-button">Confirm</button>

    <!-- Output Information -->
    <div *ngFor="let place of outputs" class="output-info">
      <div *ngIf="place.loading" class="loading-indicator">
        <button (click)="removeOutput(place)" class="delete-button">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <div class="rounded-md p-4 max-w-sm w-full mx-auto">
          <div class="animate-pulse flex space-x-4">
            <div class="flex-1 space-y-6 py-1">
              <div class="h-2 bg-slate-700 rounded"></div>
              <div class="space-y-3">
                <div class="grid grid-cols-3 gap-4">
                  <div class="h-2 bg-slate-700 rounded col-span-2"></div>
                  <div class="h-2 bg-slate-700 rounded col-span-1"></div>
                </div>
                <div class="h-2 bg-slate-700 rounded"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        *ngIf="!place.loading && place.type === 'nearest'"
        class="nearest-place-info"
      >
        <button (click)="removeOutput(place)" class="delete-button">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <button (click)="toggleVisibility(place)" class="toggle-button">
          {{ place.visible ? "Hide" : "Show" }}
        </button>
        <p>Nearest: {{ place.amenity }}</p>
        <p>Distance: {{ place.distance }} meters</p>
        <p>Province: {{ place.province }}</p>
        <p>Lat: {{ place.lat }}</p>
        <p>Lon: {{ place.lon }}</p>
      </div>

      <div
        *ngIf="!place.loading && place.type === 'count'"
        class="amenities-count-info"
      >
        <button (click)="removeOutput(place)" class="delete-button">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <button (click)="toggleVisibility(place)" class="toggle-button">
          {{ place.visible ? "Hide" : "Show" }}
        </button>
        <p>Amenity: {{ place.amenity }}</p>
        <p>Distance: {{ place.distance }} meters</p>
        <p>Count: {{ place.count }}</p>

        <ul>
          <li *ngFor="let amenity of place.locations">
            Lat: {{ amenity.lat }}, Lon: {{ amenity.lon }}
          </li>
        </ul>
      </div>

      <div
        *ngIf="!place.loading && place.type === 'population'"
        class="population-info"
      >
        <button (click)="removeOutput(place)" class="delete-button">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <button (click)="toggleVisibility(place)" class="toggle-button">
          {{ place.visible ? "Hide" : "Show" }}
        </button>
        <p>Population:</p>
        <p>Distance: {{ place.distance }} meters</p>
        <p>Population: {{ place.population }}</p>
      </div>

      <div
        *ngIf="!place.loading && place.type === 'predict'"
        class="predict-info"
      >
        <button (click)="removeOutput(place)" class="delete-button">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <button (click)="toggleVisibility(place)" class="toggle-button">
          {{ place.visible ? "Hide" : "Show" }}
        </button>
        <p>Prediction Results:</p>
        <p>Most Suitable Amenity</p>
        <p *ngFor="let pred of place.top_predictions">
          {{ pred.category }} : {{ (pred.score * 100).toFixed(2) }}%
        </p>
        <p>other : {{ place.remaining_score.toFixed(2) }}%</p>
      </div>
    </div>
  </div>
</div>

<div class="search-container">
  <div class="search-bar">
    <input
      type="text"
      placeholder="Search location"
      (input)="onSearchInput($event)"
      #searchInput
    />
    <ul class="suggestions" *ngIf="suggestions.length">
      <li
        *ngFor="let suggestion of suggestions"
        (click)="selectSuggestion(suggestion)"
      >
        <span class="icon">📍</span>
        {{ suggestion.display_name }}
      </li>
    </ul>
  </div>
</div>

<div *ngIf="showHistoryModal" class="modal">
  <div class="modal-content">
    <span class="close" (click)="closeHistoryModal()">&times;</span>
    <h2>Saved Maps History</h2>
    <ul>
      <li *ngFor="let map of savedMaps" (click)="loadMap(map)">
        Map ID: {{ map.id }}, Map Name: {{ map.name }}
      </li>
    </ul>
  </div>
</div>
